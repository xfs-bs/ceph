
<form [formGroup]="formGroup"
      novalidate>
  <div cdsGrid
       [useCssGrid]="true"
       [narrow]="true"
       [fullWidth]="true">
    <div cdsCol
         [columnNumbers]="{lg: 10}"
         class="cd-nvmeof-subsystem-step-two">
      <div cdsRow
           class="form-item cds-mb-0">
        <h3 class="cds--type-heading-03"
            i18n>Host access (Initiators)</h3>
        <p
          class="cds--type-label-02"
          i18n>Select hosts that can initiate connections to this subsystem.</p>
      </div>
      <div cdsRow
           class="form-item">
        <cds-radio-group
          formControlName="hostType"
          orientation="vertical">
          <cds-radio
            [value]="HOST_TYPE.ALL"
            class="cds-mb-2"
            i18n>Allow all hosts</cds-radio>
          <span class="cds--form__helper-text cds-mb-3"
                i18n>Any host can connect to this subsystem without verification.</span>
          @if(formGroup.get('hostType').value === HOST_TYPE.ALL) {
          <cd-alert-panel
            title="Caution"
            type="warning"
            class="cds-mb-3"
            i18n
            i18n-title>
            Allowing all hosts grants access to every initiator on the network. Authentication is not supported in this mode, which may expose the subsystem to unauthorized access.
          </cd-alert-panel>
          }
          <cds-radio
            [value]="HOST_TYPE.SPECIFIC"
            class="cds-mb-2">
            <span
              class="cds-mr-3"
              i18n>Restrict to specific hosts</span>
            <cds-tag
              type="blue"
              size="sm"
              class="cd-nvmeof-subsystem-step-two-specific-hosts-tag"
              i18n>
              Recommended for secure environments
            </cds-tag>
          </cds-radio>
          <span class="cds--form__helper-text cds-mb-3"
                i18n>Add the specific hosts permitted to connect.</span>
        </cds-radio-group>
      </div>
      @if(formGroup.get('hostType').value === HOST_TYPE.SPECIFIC) {
      <div cdsRow
           class="form-item">
        <h1
          class="cds--type-heading-compact-01"
          i18n>Add host manually</h1>
        <label class="cds--label"
               for="hostname">
          <span i18n>Host name</span>
        </label>
        <div class="cd-nvmeof-subsystem-step-two-manual-hosts">
          <cds-text-label
            [invalid]="host.isInvalid"
            [invalidText]="hostNameInvalidTemplate"
            class="cd-nvmeof-subsystem-step-two-manual-hosts-input">
          <input
            cdsText
            cdValidate
            id="hostname"
            #host="cdValidate"
            formControlName="hostname"
            [invalid]="host.isInvalid"
            placeholder="Enter host NQN"
            i18n-placeholder/>
          </cds-text-label>
          <button
            cdsButton="tertiary"
            [disabled]="host.isInvalid"
            size="md"
            class="cds-mt-3"
            (click)="addHost()">
            <span i18n>Add</span>
            <cd-icon type="add"></cd-icon>
          </button>
        </div>
      </div>
      }
    </div>
  </div>
</form>

<ng-template #removeAllTemplate>
  <button
    i18n
    cdsButton="ghost"
    (click)="removeAll($event)">
    Remove all
  </button>
</ng-template>

<ng-template
  #removeHostTemplate
  let-host>
  <cds-icon-button
    type="button"
    kind="ghost"
    description="Remove host"
    i18n-description
    (click)="removeHost(host)">
  <cd-icon type="destroy"></cd-icon>
</cds-icon-button>
</ng-template>

<ng-template #rightInfluencer>
  @if(addedHostsLength === 0) {
  <h1
    class="cds--type-heading-compact-01"
    i18n>Added hosts ({{addedHostsLength}})</h1>
  <p
    i18n
    class="cds--type-body-01 cd-nvmeof-subsystem-step-two-added-hosts-text">No hosts added yet. Add hosts manually or upload a CSV file.</p>
  } @else {
  <cds-contained-list
    label="Added hosts ({{addedHostsLength}})"
    [action]="removeAllTemplate"
    class="cd-nvmeof-subsystem-step-two-influencer">
    @for (host of formGroup.get('addedHosts')?.value ; track host) {
    <cds-contained-list-item
      [action]="removeHostTemplate"
      [actionData]="host"
      class="cd-nvmeof-subsystem-step-two-host-list-item-container">
      <span
        class="cds--text-truncate--end"
        [title]="host">{{host}}</span>
    </cds-contained-list-item>
    }
  </cds-contained-list>
  }
</ng-template>

<ng-template #hostNameInvalidTemplate>
@for (err of formGroup.get('hostname').errors | keyvalue; track err.key) {
<span class="invalid-feedback">{{ INVALID_TEXTS[err.key] }}</span>
}
</ng-template>
